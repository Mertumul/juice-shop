name: 🧃 Juice Shop - SBOM & Semgrep & Gitleaks Scan

on:
  workflow_dispatch:

jobs:
  build-and-sbom:
    name: 🔧 Build Docker & Generate SBOM
    runs-on: ubuntu-latest

    steps:
    - name: 📥 Checkout source
      uses: actions/checkout@v3

    - name: 🐳 Set up Docker
      uses: docker/setup-buildx-action@v3

    - name: 🏗️ Build Juice Shop Docker Image
      run: |
        docker build -t juice-shop-local .

    - name: 🧰 Install Syft
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

    - name: 📦 Generate SBOM with Syft
      run: |
        syft juice-shop-local -o spdx-json > sbom.json

    - name: ☁️ Upload SBOM as artifact
      uses: actions/upload-artifact@v4
      with:
        name: sbom
        path: sbom.json

  sast-with-semgrep:
    name: 🛡️ Semgrep SAST Scan
    runs-on: ubuntu-latest

    permissions:
      security-events: write  # SARIF raporu için gerekli

    steps:
    - name: 📥 Checkout source
      uses: actions/checkout@v3

    - name: 🔍 Run Semgrep with Docker
      run: |
        docker run --rm \
          -v "${{ github.workspace }}:/src" \
          returntocorp/semgrep \
          semgrep scan --config auto \
          --sarif --output /src/semgrep-results.sarif

    - name: ☁️ Upload SARIF to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: semgrep-results.sarif

    - name: 📦 Upload Semgrep SARIF as artifact
      uses: actions/upload-artifact@v4
      with:
        name: semgrep-sarif
        path: semgrep-results.sarif

  gitleaks-scan:
    name: 🔍 Gitleaks Secret Scan
    runs-on: ubuntu-latest
    continue-on-error: true  # Hata durumunda devam etmesini sağlar

    steps:
    - name: 📥 Checkout source
      uses: actions/checkout@v3

    - name: 🚨 Run Gitleaks
      uses: gitleaks/gitleaks-action@v2
      with:
        config-path: ""  # varsayılan kurallarla tarar
        args: "--report-format sarif --report-path gitleaks-results.sarif"

    - name: ☁️ Upload SARIF to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: gitleaks-results.sarif

    - name: 📦 Upload Gitleaks SARIF as artifact
      uses: actions/upload-artifact@v4
      with:
        name: gitleaks-sarif
        path: gitleaks-results.sarif
