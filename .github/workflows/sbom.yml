name: ğŸ§ƒ Juice Shop - SBOM, Semgrep & Gitleaks Scan

on:
  workflow_dispatch:

jobs:
  build-and-sbom:
    name: ğŸ”§ Build Docker & Generate SBOM
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout source
      uses: actions/checkout@v3

    - name: ğŸ³ Set up Docker
      uses: docker/setup-buildx-action@v3
name: ğŸ§ƒ Juice Shop - SBOM, Semgrep & Gitleaks Scan

on:
  workflow_dispatch:

jobs:
  build-and-sbom:
    name: ğŸ”§ Build Docker & Generate SBOM
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout source
      uses: actions/checkout@v3

    - name: ğŸ³ Set up Docker
      uses: docker/setup-buildx-action@v3

    - name: ğŸ—ï¸ Build Juice Shop Docker Image
      run: |
        docker build -t juice-shop-local .

    - name: ğŸ§° Install Syft
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

    - name: ğŸ“¦ Generate SBOM with Syft
      run: |
        syft juice-shop-local -o spdx-json > sbom.json

    - name: â˜ï¸ Upload SBOM as artifact
      uses: actions/upload-artifact@v4
      with:
        name: sbom
        path: sbom.json

  sast-with-semgrep:
    name: ğŸ›¡ï¸ Semgrep SAST Scan
    runs-on: ubuntu-latest

    permissions:
      security-events: write  # SARIF raporu iÃ§in gerekli

    steps:
    - name: ğŸ“¥ Checkout source
      uses: actions/checkout@v3

    - name: ğŸ” Run Semgrep with Docker
      run: |
        docker run --rm \
          -v "${{ github.workspace }}:/src" \
          returntocorp/semgrep \
          semgrep scan --config auto \
          --sarif --output /src/semgrep-results.sarif

    - name: â˜ï¸ Upload SARIF to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: semgrep-results.sarif

    - name: ğŸ“¦ Upload Semgrep SARIF as artifact
      uses: actions/upload-artifact@v4
      with:
        name: semgrep-sarif
        path: semgrep-results.sarif

  gitleaks-scan:
    name: ğŸ” Gitleaks Secret Scan
    runs-on: ubuntu-latest
    continue-on-error: true  # Hata olsa bile devam etmesini saÄŸlar

    steps:
    - name: ğŸ“¥ Checkout source
      uses: actions/checkout@v3

    - name: ğŸš¨ Run Gitleaks using Docker image
      run: |
        docker run --rm \
          -v "${{ github.workspace }}:/repo" \
          ghcr.io/gitleaks/gitleaks:v8.24.3 \
          detect --redact --exit-code=2 --report-format=sarif --report-path=/repo/results.sarif --log-level=debug || true  # Hata olsa da devam etmesi iÃ§in '|| true' ekledik

    - name: ğŸ’¾ Check if SARIF file exists
      run: |
        echo "ğŸ” Checking if SARIF file exists..."
        if [ ! -f /repo/results.sarif ]; then
          echo "ğŸ”´ Gitleaks SARIF report not found!"
        else
          echo "âœ… Gitleaks SARIF report found."
        fi

    - name: â˜ï¸ Upload SARIF to GitHub Security (if exists)
      if: success() && ( steps.gitleaks-scan.outputs.result == 'found' )
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: /repo/results.sarif

    - name: ğŸ“¦ Upload Gitleaks SARIF as artifact
      uses: actions/upload-artifact@v4
      with:
        name: gitleaks-sarif
        path: /repo/results.sarif

  dummy-deploy:
    name: ğŸš€ Dummy Deploy
    runs-on: ubuntu-latest
    continue-on-error: true  # Hata olsa da devam etmesini saÄŸlar

    steps:
    - name: ğŸ“¥ Checkout source
      uses: actions/checkout@v3

    - name: ğŸ—ï¸ Dummy deploy
      run: |
        echo "Deploying the Juice Shop Application..."  # Burada deploy komutunuzu Ã§alÄ±ÅŸtÄ±rabilirsiniz
        echo "ğŸŸ¢ Dummy Deploy completed!"

    - name: ğŸ—ï¸ Build Juice Shop Docker Image
      run: |
        docker build -t juice-shop-local .

    - name: ğŸ§° Install Syft
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

    - name: ğŸ“¦ Generate SBOM with Syft
      run: |
        syft juice-shop-local -o spdx-json > sbom.json

    - name: â˜ï¸ Upload SBOM as artifact
      uses: actions/upload-artifact@v4
      with:
        name: sbom
        path: sbom.json

  sast-with-semgrep:
    name: ğŸ›¡ï¸ Semgrep SAST Scan
    runs-on: ubuntu-latest

    permissions:
      security-events: write  # SARIF raporu iÃ§in gerekli

    steps:
    - name: ğŸ“¥ Checkout source
      uses: actions/checkout@v3

    - name: ğŸ” Run Semgrep with Docker
      run: |
        docker run --rm \
          -v "${{ github.workspace }}:/src" \
          returntocorp/semgrep \
          semgrep scan --config auto \
          --sarif --output /src/semgrep-results.sarif

    - name: â˜ï¸ Upload SARIF to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: semgrep-results.sarif

    - name: ğŸ“¦ Upload Semgrep SARIF as artifact
      uses: actions/upload-artifact@v4
      with:
        name: semgrep-sarif
        path: semgrep-results.sarif

  gitleaks-scan:
    name: ğŸ” Gitleaks Secret Scan
    runs-on: ubuntu-latest
    continue-on-error: true  # Hata olsa bile devam etmesini saÄŸlar

    steps:
    - name: ğŸ“¥ Checkout source
      uses: actions/checkout@v3

    - name: ğŸš¨ Run Gitleaks using Docker image
      run: |
        docker run --rm \
          -v "${{ github.workspace }}:/repo" \
          ghcr.io/gitleaks/gitleaks:v8.24.3 \
          detect --redact --exit-code=2 --report-format=sarif --report-path=/repo/results.sarif --log-level=debug || true  # Hata olsa da devam etmesi iÃ§in '|| true' ekledik

    - name: ğŸ’¾ Check if SARIF file exists
      run: |
        echo "ğŸ” Checking if SARIF file exists..."
        if [ ! -f /repo/results.sarif ]; then
          echo "ğŸ”´ Gitleaks SARIF report not found!"
          exit 1
        fi
        echo "âœ… Gitleaks SARIF report found."

    - name: â˜ï¸ Upload SARIF to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: /repo/results.sarif

    - name: ğŸ“¦ Upload Gitleaks SARIF as artifact
      uses: actions/upload-artifact@v4
      with:
        name: gitleaks-sarif
        path: /repo/results.sarif

  dummy-deploy:
    name: ğŸš€ Dummy Deploy
    runs-on: ubuntu-latest
    continue-on-error: true  # Hata olsa da devam etmesini saÄŸlar

    steps:
    - name: ğŸ“¥ Checkout source
      uses: actions/checkout@v3

    - name: ğŸ—ï¸ Dummy deploy
      run: |
        echo "Deploying the Juice Shop Application..."  # Burada deploy komutunuzu Ã§alÄ±ÅŸtÄ±rabilirsiniz
        echo "ğŸŸ¢ Dummy Deploy completed!"
